<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Discuss Closure | Steven's Blog</title><meta name="description" content="Talk about Closure with examples and questions"><meta name="generator" content="Steven's Blog"><meta name="author" content="Steven Zhao"><meta name="keywords" content="stevenzhao, web, javascript, nodejs, blog, front end, backend, fullstack, developer"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="160x160" href="/images/favicon-160x160.png"><link rel="icon" type="image/png" sizes="192x192" href="/images/favicon-192x192.png"><meta name="msapplication-TileColor" content="#121315"><meta name="msapplication-TileImage" content="/images/mstile-144x144.png"></head><body itemscope itemtype="https://schema.org/WebPage"><header itemscope itemtype="https://schema.org/WPHeader"><a href="/"><img src="/images/svdb.png" alt="Steven's Blog" title="Steven's Blog"></a><h1><a href="/" alt="Steven's Blog" title="Steven's Blog" itemprop="headline">Steven's Blog</a></h1><p itemprop="description">Summary of day to day development</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name"><a href="/" alt="Home" title="Home" itemprop="url">Home</a></li><li itemprop="name"><a href="/projects" alt="Projects" title="Projects" itemprop="url">Projects</a></li><li itemprop="name"><a href="/about" alt="About" title="About" itemprop="url">About</a></li></ul></nav><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><article class="full"><h1 itemprop="headline">Discuss Closure</h1><span class="post-meta">Published on<time itemprop="datePublished" datetime="2018-04-28T07:19:41.000Z"> Saturday, April 28th 2018 at 15:19</time><br>Last updated on<time itemprop="dateModified" datetime="2018-04-28T07:19:41.000Z"> Tuesday, May 21st 2019 at 15:08</time></span><p>When talk about JavaScript, we must talk <strong>closure</strong> which is both dangerous and powerful native attribute of JavaScript. We may have already used it everyday, just not pay attention to it. When confusedness comes out, we observe it. </p>
<p>In this brief article, I will share my own understanding of the basic concept of <strong>closure</strong> with example explanations, also list a few common closure interview questions at the end.<br><a id="more"></a><br>More detail explain can refer <a href="https://github.com/getify/You-Dont-Know-JS/blob/master/scope%20%26%20closures/ch5.md" target="_blank" rel="noopener">here</a></p>
<p>I hope this article can help some closure beginners to pick it up quickly before diving deep.</p>
<h3 id="What-is-closure"><a href="#What-is-closure" class="headerlink" title="What is closure?"></a>What is closure?</h3><p>By definition:</p>
<blockquote>
<p>closure is when a function is able to remember and access its lexical scope even when that function is executing outside its  lexical scope.</p>
</blockquote>
<p><strong>Lexical scope</strong> just means the code scope during the author time. When I write the following code, it will natively have the lexical scope.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// lexical scope start</span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">2</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">bar</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(a)</span><br><span class="line">  &#125;</span><br><span class="line">  bar()</span><br><span class="line">  <span class="comment">// lexical scope end</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>In the function <em>foo</em>, it creates a protected scope inside it function body, which actually is the lexical scope of the function <em>bar</em>. So <strong>closure</strong> means when function <em>bar</em> is fired in the outside of function <em>foo</em>, it will get the access to original scope, it knows the variable a equals 2 in this case.</p>
<p>To be specifically, the lexical scope of <em>bar</em> is not only the body of function <em>foo</em>, the outside of the <em>foo</em> is also the lexical scope of <em>bar</em>. But for better understanding, we limit the lexical scope to the area where has variable definition.</p>
<p>The definition is not complicate, but the real situation might go confuse, letâ€™s see some examples</p>
<h3 id="Get-hands-dirty"><a href="#Get-hands-dirty" class="headerlink" title="Get hands dirty"></a>Get hands dirty</h3><p>Example I:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// lexical scope start</span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">2</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">bar</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(a)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bar</span><br><span class="line">  <span class="comment">// lexical scope end</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> baz = foo ()</span><br><span class="line">baz() <span class="comment">// output: 2</span></span><br></pre></td></tr></table></figure></p>
<p>In the example I, after the execute of <em>foo</em>, the return has been assigned to baz, at this moment, JavaScript will clean the memory of function <em>foo</em> to save more clean space. But when we fire <em>baz</em>, the magic appears, it still remembers that the varible a equals to 2. Because of <strong>closure</strong>, the <em>bar</em> will still remember the lexical scope when it was authoring.</p>
<p>Example II:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fn</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">2</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">bar</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(a)</span><br><span class="line">  &#125;</span><br><span class="line">  fn = bar</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">baz</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  fn ()</span><br><span class="line">&#125;</span><br><span class="line">foo ()</span><br><span class="line">baz () <span class="comment">// output: 2</span></span><br></pre></td></tr></table></figure></p>
<p>In the Examlpe II, we do not return <em>bar</em>, instead, we assign it to a globle variable fn, which will be called when we fire funciton <em>baz</em>. Similarly, after function <em>foo</em> is fired, the body of <em>foo</em> will be cleaned, means the assignment of <em>a</em> will not be here anymore, but function <em>bar</em> still get the reference copy of its lexical scope when it was authoring. Thatâ€™s why the output still is 2.</p>
<p>Example III:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// for block start</span></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">  <span class="comment">// for block end</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Things get complicate, whatâ€™s the output of the Example III? The answer is <em>3 3 3</em>.<br>Why they are three 3? I guess most of closure begineers will think the result is <em>0 1 2</em>.</p>
<p>First I want to explain why the result is 3. In JavaScript, there is a timeout queque, when timeout is setup inside the for loop, each loop will push a new timeout to queue, when for loop is finished, the timeout queue will be fired together. So the end status of <em>i</em> is 3, thatâ€™s the reason why itâ€™s 3.</p>
<p>Another question is that, why all the results are same?</p>
<p>In the for block, all the function will share the same reference of <em>i</em>, that means each loop will not have a new scope instance, they are all in the same scope. Therefore, in this example, the final status of <em>i</em> is 3, so when for loop ends, there will be three 3.</p>
<p>If we want to make the result as our expectation, we can take advantage of <em>closure</em>. According to the <em>closure</em> definition, the function can remember its lexical scope in the authoring time. In the above example, the parent lexical scope of timeout callback function is the scope of for loop block. So they have the same reference to <em>i</em>. We just need to make callback function has its own new lexical scope in the each for loop.</p>
<p>Letâ€™s try <em>IIFE</em> first:</p>
<p>Example IV:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// for block start</span></span><br><span class="line">  (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(i)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;)()</span><br><span class="line">  <span class="comment">// for block end</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>IIFE will generate a standalone scope, but in this example we do nothing, the <em>i</em> will still have direct refernce to <em>i</em> in the for loop. Letâ€™s pass <em>i</em> as a function parameter.</p>
<p>Example V:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// for block start</span></span><br><span class="line">  (<span class="function"><span class="keyword">function</span> (<span class="params">i</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(i)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;)(i)</span><br><span class="line">  <span class="comment">// for block end</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Yup! We got what we expected now! The result of this function will be <em>0 1 2</em>.</p>
<p>The difference between this example with previous one is that, we created a closured scope, and this scope will have different <em>i</em> in the each iteration. When callback function is fired, although it is out the original scope, it still get the access to the <em>i</em> we passed to the closured scope.</p>
<p>Similarly way, we can use <em>let</em> keyword to create a new scope in the each iteration.</p>
<p>Example VI:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// for block start</span></span><br><span class="line">  <span class="keyword">let</span> j = i</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(j)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">  <span class="comment">// for block end</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>Let</em> keyword is introduced in the ES6, which will make variable be scoped. So in the each iteration, there is a new closured scope which includes the different <em>i</em>. Then, when the callback is fired, it can get the access to that scope when it is authored.</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p><em>Closure</em> is a native character of JavaScript, means the function can keep the access to its lexical scope even when this funciton is executed outside the original scope. So if we want to take advantage of closure, we need to create a scope which includes both the function and the states that function wants to remember.</p>
<h3 id="Common-Questions"><a href="#Common-Questions" class="headerlink" title="Common Questions"></a>Common Questions</h3><ol>
<li><p>Write a function which allow you to do this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> addSix = createBase(<span class="number">6</span>);</span><br><span class="line">addSix(<span class="number">10</span>); <span class="comment">// returns 16</span></span><br><span class="line">addSix(<span class="number">21</span>); <span class="comment">// returns 27</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Consider the following code. What will be printed on the console if a user clicks the first and the fourth button in the list? Why?</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nodes = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'button'</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; nodes.length; i++) &#123;</span><br><span class="line">   nodes[i].addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'You clicked element #'</span> + i);</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Fix the previous questionâ€™s issue so that the handler prints 0 for the first button in the list, 1 for the second, and so on.</p>
</li>
</ol>
</article><section id="comments"><h2>Comments<div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript></div></h2></section></main><script async>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src = '//' + l + '.disqus.com/' + k + '.js', i.parentNode.insertBefore(j, i)})
(document,'script','steven369blog','embed');
</script><script async>var disqus_shortname = 'steven369blog';
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = '//' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
}());
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-106933947-1');ga('send','pageview');</script></body></html>