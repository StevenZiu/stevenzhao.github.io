<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Thinking in Document - MongoDB First Bootstrap With Mongoose | Steven's Blog</title><meta name="description" content="Basic thing about setup MongoDB with Mongoose"><meta name="generator" content="Steven's Blog"><meta name="author" content="Steven Zhao"><meta name="keywords" content="stevenzhao, web, javascript, nodejs, blog, front end, backend, fullstack, developer"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="160x160" href="/images/favicon-160x160.png"><link rel="icon" type="image/png" sizes="192x192" href="/images/favicon-192x192.png"><meta name="msapplication-TileColor" content="#121315"><meta name="msapplication-TileImage" content="/images/mstile-144x144.png"></head><body itemscope itemtype="https://schema.org/WebPage"><header itemscope itemtype="https://schema.org/WPHeader"><a href="/"><img src="/images/svdb.png" alt="Steven's Blog" title="Steven's Blog"></a><h1><a href="/" alt="Steven's Blog" title="Steven's Blog" itemprop="headline">Steven's Blog</a></h1><p itemprop="description">Summary of day to day development</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name"><a href="/" alt="Home" title="Home" itemprop="url">Home</a></li><li itemprop="name"><a href="/projects" alt="Projects" title="Projects" itemprop="url">Projects</a></li><li itemprop="name"><a href="/about" alt="About" title="About" itemprop="url">About</a></li></ul></nav><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><article class="full"><h1 itemprop="headline">Thinking in Document - MongoDB First Bootstrap With Mongoose</h1><span class="post-meta">Published on<time itemprop="datePublished" datetime="2017-06-26T12:46:51.000Z"> Monday, June 26th 2017 at 20:46</time><br>Last updated on<time itemprop="dateModified" datetime="2017-06-26T12:46:51.000Z"> Tuesday, May 21st 2019 at 15:08</time></span><p>MongoDB is a NoSQL (not only SQL), or you can call it Object-relational mapping database (ORM), which provides the object-way to manage and manipulate data. There is a bunch of articles on the Internet to do a comparison between MongoDB and MySql, which is not the main concern of this article. The major target of this article is to help MongoDB beginner understand the basic concepts inside the Mongo, and get hands on the mongo. </p>
<p>This article will contain two parts, the first part will introduce the mongodb structure, second part will give an example about mongo initialising, and how to manipulate data. Some specific discussion of mongo will be published in the other articles.<br><a id="more"></a><br><i class="fa fa-check-circle"></i> <strong>Part One - Collection And Document</strong></p>
<p>The most important task of DB is to store data, and provide the way for outside to retrieve data. So how are we gonna to store data in mongo way? Letâ€™s forget the MySql, take a look at the following image.</p>
<p><img src="/images/mongo-structure.jpg" alt="MongoDB Data Structure" title="MongoDB Data Structure"></p>
<p>In the mongodb, we also have a database, but inside the database, there is no table, instead, there are collections. The collections collect one or more document. If it is hard to remember and understand, you can treat the collection as the table, document as the row inside the table. </p>
<p>But the magic is here, the document is object, which can store anything in any format just like you create the object in Javascript. If one property of the object is complicated, you could even use another object to represent that property, but in mysql, you need to reference other tables to realize this. Besides, collection could have its own methods, for example, you could define a hash function for a collection to hash the password before store it in one document. The amazing things are not only these, but for beginner, switch the way to think in document is the most important. Once we get used to this kind of thinking, we could go deep to understand some much more complex but powerful functions. </p>
<p>Then, we will take a look at a real example.</p>
<p><i class="fa fa-check-circle"></i> <strong>Part Two - Example of Mongodb Bootstrap</strong></p>
<p>In this example, I will do some most basic but important things about how to initialize Mongo, and Create, Read, Update, Delete data inside Mongo. For a better explanation and understanding, I will take contact book as the example data model.</p>
<p> Some tools will be used here: </p>
<p> <a href="https://robomongo.org/" target="_blank" rel="noopener">Robomongo</a> - One GUI for MongoDB<br> <a href="http://mongoosejs.com/" target="_blank" rel="noopener">Mongoose</a> - A MongoDB Driver</p>
<p> First, create a package.json file to include the required dependencies.</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//package.json</span></span><br><span class="line"> &#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"mongo-bootstrap"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="string">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"mongodb"</span>: <span class="string">"2.2.29"</span>,</span><br><span class="line">    <span class="string">"mongoose"</span>: <span class="string">"4.11.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"author"</span>: <span class="string">"stevenzhao"</span>,</span><br><span class="line">  <span class="string">"license"</span>: <span class="string">"ISC"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Although there is no table, we still need the schema to organize the data inside document. Remember that, the collection collects one or more document, each document could have different schema.</p>
<h4 id="Create-Database"><a href="#Create-Database" class="headerlink" title="Create Database"></a>Create Database</h4><p>Before we start everything, you should create a database on the local server (localhost). In the real production development, we seldom use script to create database, because the database will be setup in the local for development, so just go to Robomongo to create a database called <strong>contact-book</strong>.</p>
<h4 id="Create-Collection"><a href="#Create-Collection" class="headerlink" title="Create Collection"></a>Create Collection</h4><p>Make a standalone file - contact-book-collection.js, which will define the document schema, and create the collection which contains the document.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">var</span> schema = mongoose.Schema;</span><br><span class="line"></span><br><span class="line"><span class="comment">// create schema for contack-book document</span></span><br><span class="line"><span class="comment">// remember, each document represents one contact person</span></span><br><span class="line"><span class="keyword">var</span> person_schema = <span class="keyword">new</span> schema(&#123;</span><br><span class="line">  name:      &#123;<span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">maxlength</span>: <span class="number">20</span>, <span class="attr">unique</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">  number:    &#123;<span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">maxlength</span>: <span class="number">10</span>, <span class="attr">unique</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">  age:       &#123;<span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">required</span>: <span class="literal">false</span>, <span class="attr">maxlength</span>: <span class="number">2</span>&#125;,</span><br><span class="line">  createdAt: &#123;<span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">required</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">  updateAt:  &#123;<span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">required</span>: <span class="literal">false</span>&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>In this example, we can use mongoose Schema function to define schema. For better understanding, we could just think we are defining an object, this object has some properties, and each property will have some requirement which is defined by using object as well. There are many schema types in mongoose, the more detail reference is <a href="http://mongoosejs.com/docs/api.html" target="_blank" rel="noopener">here</a>.</p>
<p>After defining the schema, we will implement it to create document and the collection where the document stays.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define the collection with document which implements document schema</span></span><br><span class="line"><span class="comment">// collection contains many documents</span></span><br><span class="line"><span class="keyword">var</span> Persons = mongoose.model(<span class="string">'person'</span>, person_schema, <span class="string">'persons'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//export this collection</span></span><br><span class="line"><span class="built_in">module</span>.exports = Persons;</span><br></pre></td></tr></table></figure>
<p>The mongoose.model function takes first parameter as the document name, the second parameter as the document schema, the third will be collection name, if it is ignored, the mongoose will generate one automatically. Then we export this collection.</p>
<p>Mongoose also provides pre save function, which means the function which will be executed before the document saving. For example, hash some sensitive data before save it to database.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define a pre-save function to update date automatically</span></span><br><span class="line">person_schema.pre(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> current_time = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="keyword">this</span>.updateAt = current_time;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">this</span>.createdAt === <span class="literal">undefined</span>)&#123;</span><br><span class="line">    <span class="keyword">this</span>.createdAt = current_time;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// call next pre-save function or other functions</span></span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>In this example, we define a pre save function to generate the created date and updated date.</p>
<p>Now, we have successfully defined the document schema, and use it to create a collection. The full file is here:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//contact-book-collection.js</span></span><br><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">var</span> schema = mongoose.Schema;</span><br><span class="line"></span><br><span class="line"><span class="comment">// create schema for contack-book document</span></span><br><span class="line"><span class="comment">// remember, each document represents one contact person</span></span><br><span class="line"><span class="keyword">var</span> person_schema = <span class="keyword">new</span> schema(&#123;</span><br><span class="line">  name:      &#123;<span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">maxlength</span>: <span class="number">20</span>, <span class="attr">unique</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">  number:    &#123;<span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">maxlength</span>: <span class="number">10</span>, <span class="attr">unique</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">  age:       &#123;<span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">required</span>: <span class="literal">false</span>, <span class="attr">maxlength</span>: <span class="number">2</span>&#125;,</span><br><span class="line">  createdAt: &#123;<span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">required</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">  updateAt:  &#123;<span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">required</span>: <span class="literal">false</span>&#125;</span><br><span class="line">&#125;); </span><br><span class="line"></span><br><span class="line"><span class="comment">// define a pre-save function to update date automatically</span></span><br><span class="line">person_schema.pre(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> current_time = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="keyword">this</span>.updateAt = current_time;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">this</span>.createdAt === <span class="literal">undefined</span>)&#123;</span><br><span class="line">    <span class="keyword">this</span>.createdAt = current_time;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// call next pre-save function or other functions</span></span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// define the collection with document which implements document schema</span></span><br><span class="line"><span class="comment">// collection contains many documents</span></span><br><span class="line"><span class="keyword">var</span> Persons = mongoose.model(<span class="string">'person'</span>, person_schema, <span class="string">'persons'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//export this collection</span></span><br><span class="line"><span class="built_in">module</span>.exports = Persons;</span><br></pre></td></tr></table></figure>
<h4 id="Create-Database-Connection-and-Insert-Data"><a href="#Create-Database-Connection-and-Insert-Data" class="headerlink" title="Create Database Connection and Insert Data"></a>Create Database Connection and Insert Data</h4><p>Once created the collection, itâ€™s time to put the collection in the database. Create another file called mongo-bootstrap.js. First we need to import the collection, then connect the database.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="comment">// import Persons collection</span></span><br><span class="line"><span class="keyword">var</span> Persons = <span class="built_in">require</span>(<span class="string">'./contact-book-collection'</span>);</span><br><span class="line"><span class="comment">// initialize the connection</span></span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/contact-book'</span>);</span><br><span class="line"><span class="comment">// store the connection instance</span></span><br><span class="line"><span class="keyword">var</span> connect = mongoose.connection;</span><br></pre></td></tr></table></figure>
<p>After we import the collection definition, we have not connected it with any database, so we connect the local database <strong>contact-book</strong> which should be created manually in the Robomongo ni the first step. Then, we store the connection instance to a variable, which will be used to listen database connection status. Once the database connects successfully, we could insert data.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// watch the database events</span></span><br><span class="line">connect.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);   </span><br><span class="line">&#125;); </span><br><span class="line"></span><br><span class="line">connect.on(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'database connect successfully!'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Now we have successfully connected the database <strong>contack-book</strong>, also import the collection definition. Itâ€™s time for us to insert some data.</p>
<p>Remember that, for mongo, we use document to represent data, and document actually is object, so we could create document just like we create object in javascript.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create document object</span></span><br><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> Persons(&#123;</span><br><span class="line">  name: <span class="string">'steven'</span>,</span><br><span class="line">  number: <span class="number">68183333</span>,</span><br><span class="line">  age: <span class="number">25</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Now, we have created a person document. In order to make the person is unique in the collection, so we need to check whether there is a duplicate record in collection, so we call <strong>find</strong> function to check inside collection, there will be more examples explain how to query data later. If no duplicate record, call <strong>save</strong> function to insert this document. <strong>save</strong> will also take a callback function.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// first way to initilize one document</span></span><br><span class="line">Persons.find(&#123;<span class="attr">name</span>: person.name, <span class="attr">number</span>: person.number&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(err) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span>(data.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// the document already in the collection</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'data already in the collection'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    person.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'data insert successfully'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>We also can create new document directly from collection.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// second way to initilize one document</span></span><br><span class="line">Persons.create(&#123;</span><br><span class="line">  name: <span class="string">'Jack'</span>,</span><br><span class="line">  number: <span class="number">68182333</span>,</span><br><span class="line">  age: <span class="number">25</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(err)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'data insert successfully'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>or Multiple inserting by using array.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> multipleInsert = </span><br><span class="line">  [&#123;<span class="attr">name</span>: <span class="string">'Jane Doe'</span>, <span class="attr">number</span>: <span class="number">89792312</span>, <span class="attr">age</span>: <span class="number">13</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">name</span>: <span class="string">'Jane Doe 1'</span>, <span class="attr">number</span>: <span class="number">89792322</span>, <span class="attr">age</span>: <span class="number">23</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">name</span>: <span class="string">'Jane Doe 2'</span>, <span class="attr">number</span>: <span class="number">89792342</span>, <span class="attr">age</span>: <span class="number">33</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">name</span>: <span class="string">'Jane Doe 3'</span>, <span class="attr">number</span>: <span class="number">89792362</span>, <span class="attr">age</span>: <span class="number">43</span>&#125;];</span><br><span class="line"></span><br><span class="line">Persons.create(multipleInsert, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"multiple insert successfully"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>The second parameter for create function is a callback function, if we do not pass this function to create, this query will not execute, instead, a query string will be returned, then we will need to call exec() function manually. This feature enables a way to chain multiple query together to finish some much more complicated query</strong></p>
<p>You will see some examples following.</p>
<p>The full file is here:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="comment">// import Persons collection</span></span><br><span class="line"><span class="keyword">var</span> Persons = <span class="built_in">require</span>(<span class="string">'./contact-book-collection'</span>);</span><br><span class="line"><span class="comment">// initialize the connection</span></span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/contact-book'</span>);</span><br><span class="line"><span class="comment">// store the connection instance</span></span><br><span class="line"><span class="keyword">var</span> connect = mongoose.connection;</span><br><span class="line"><span class="comment">// watch the database events</span></span><br><span class="line">connect.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);   </span><br><span class="line">&#125;); </span><br><span class="line">connect.on(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'database connect successfully!'</span>);</span><br><span class="line">  <span class="comment">// insert data</span></span><br><span class="line">  <span class="keyword">var</span> person = <span class="keyword">new</span> Persons(&#123;</span><br><span class="line">    name: <span class="string">'steven'</span>,</span><br><span class="line">    number: <span class="number">68183333</span>,</span><br><span class="line">    age: <span class="number">25</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// first way to initilize one document</span></span><br><span class="line">  Persons.find(&#123;<span class="attr">name</span>: person.name, <span class="attr">number</span>: person.number&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(data.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="comment">// the document already in the collection</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'data already in the collection'</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      person.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(err);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'data insert successfully'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// second way to initilize one document</span></span><br><span class="line">  Persons.create(&#123;</span><br><span class="line">    name: <span class="string">'Jack'</span>,</span><br><span class="line">    number: <span class="number">68182333</span>,</span><br><span class="line">    age: <span class="number">25</span></span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'data insert successfully'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">var</span> multipleInsert = </span><br><span class="line">    [&#123;<span class="attr">name</span>: <span class="string">'Jane Doe'</span>, <span class="attr">number</span>: <span class="number">89792312</span>, <span class="attr">age</span>: <span class="number">13</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">name</span>: <span class="string">'Jane Doe 1'</span>, <span class="attr">number</span>: <span class="number">89792322</span>, <span class="attr">age</span>: <span class="number">23</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">name</span>: <span class="string">'Jane Doe 2'</span>, <span class="attr">number</span>: <span class="number">89792342</span>, <span class="attr">age</span>: <span class="number">33</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">name</span>: <span class="string">'Jane Doe 3'</span>, <span class="attr">number</span>: <span class="number">89792362</span>, <span class="attr">age</span>: <span class="number">43</span>&#125;];</span><br><span class="line">  Persons.create(multipleInsert, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"multiple insert successfully"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="Data-GET-UPDATE-DELETE"><a href="#Data-GET-UPDATE-DELETE" class="headerlink" title="Data GET, UPDATE, DELETE"></a>Data GET, UPDATE, DELETE</h4><p>Letâ€™s create a new file to explain how to do data get, update and delete.</p>
<p>Same as create the data, we first need to connect the database, and import the collection. Remember that, the document is stored inside the collection.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="comment">//connect db</span></span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/contact-book'</span>);</span><br><span class="line"><span class="comment">// import collection</span></span><br><span class="line"><span class="keyword">var</span> Persons = <span class="built_in">require</span>(<span class="string">'./contact-book-collection'</span>);</span><br><span class="line"><span class="comment">// store the connection instance</span></span><br><span class="line"><span class="keyword">var</span> connection = mongoose.connection;</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">All the query in the mongo is asynchronous, which is realised by using promise, which provides two ways to finish query, one is callback function, the other is promise chain. If you we do not pass the callback function, the query will not be executed, only return it back. In order to execute it we need to call exec() function manually. Before we call exec(), we could chain more queries to execute much more complicated query function, which is benefited from promise chain.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Simple GET:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line">connection.on(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">// find all (callback)</span></span><br><span class="line">  Persons.find(&#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="keyword">if</span>(data)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Find All'</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(data);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'No match query'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">//find all (query chain)</span></span><br><span class="line">  <span class="keyword">var</span> query = Persons.find(&#123;&#125;);</span><br><span class="line">  query.exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="keyword">if</span>(data)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Find All (query chain)'</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(data);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'No match query'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>First find all uses callback way, second one uses promise way, it only return a query string, the query will not be executed until we call exec(), and exec() will also take a callback function. The result of them is same.</p>
<p>The following query first gets the document, then gets the property of that document. If you are familiar with MySql, should be easy to understand select.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// find one with select property</span></span><br><span class="line">Persons.findOne(&#123;<span class="attr">name</span>: <span class="string">'steven'</span>&#125;, <span class="string">'age number'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(err) <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="keyword">if</span>(data)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Find one with select property'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'No match query'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// find one with select property (query chain)</span></span><br><span class="line"><span class="keyword">var</span> query = Persons.findOne(&#123;<span class="attr">name</span>: <span class="string">'steven'</span>&#125;);</span><br><span class="line">query.select(<span class="string">'age number'</span>);</span><br><span class="line">query.exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(err) <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="keyword">if</span>(data)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Find one with select property (query chain)'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'No match query'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Thanks to the promise, we could chain query together to complete much more complicated GET query:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// complex query (query chain)</span></span><br><span class="line">Persons</span><br><span class="line">  .find(&#123;&#125;)</span><br><span class="line">  .limit(<span class="number">2</span>)</span><br><span class="line">  .where(<span class="string">'age'</span>).gt(<span class="number">20</span>).lt(<span class="number">30</span>)</span><br><span class="line">  .select(<span class="string">'name number'</span>)</span><br><span class="line">  .exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="keyword">if</span>(data)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Complex Query'</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(data);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'No match query'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>UPDATE:</p>
<p>Same as GET, we also have two ways to execute UPDATE query.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//update (query chain)</span></span><br><span class="line">Persons</span><br><span class="line">  .where(&#123;<span class="attr">name</span>: <span class="string">'steven'</span>&#125;)</span><br><span class="line">  .update(&#123;<span class="attr">number</span>: <span class="number">99999999</span>&#125;)</span><br><span class="line">  .exec(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Update Data Successfully (query chain)'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">//callback way is missing here, just need to put the callback as the second parameter of update function</span></span><br></pre></td></tr></table></figure>
<p>Then REMOVE:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// remove (callback)  </span></span><br><span class="line">Persons.remove(&#123;<span class="attr">name</span>: <span class="string">'Jane Doe'</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'remove data successfully'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Actually, the mongoose provides many powerfull functions to execute query, such as findOneAndRemove, findOneAndUpdate, or deleteOne, deleteMany, etc.<br>But for beginner, the most important thing is to switch the way to think about data storing. Not Only SQL, the object-related data structure can help build much more complicated but easy understanding data structure. </p>
</article></main><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-106933947-1');ga('send','pageview');</script></body></html>