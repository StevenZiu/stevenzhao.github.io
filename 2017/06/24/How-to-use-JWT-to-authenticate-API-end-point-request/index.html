<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>How to use JWT to authenticate API end-point request | Steven's Blog</title><meta name="description" content="Introduce the JWT authentication"><meta name="generator" content="Steven's Blog"><meta name="author" content="Steven Zhao"><meta name="keywords" content="stevenzhao, web, javascript, nodejs, blog, front end, backend, fullstack, developer"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="160x160" href="/images/favicon-160x160.png"><link rel="icon" type="image/png" sizes="192x192" href="/images/favicon-192x192.png"><meta name="msapplication-TileColor" content="#121315"><meta name="msapplication-TileImage" content="/images/mstile-144x144.png"></head><body itemscope itemtype="https://schema.org/WebPage"><header itemscope itemtype="https://schema.org/WPHeader"><a href="/"><img src="/images/svdb.png" alt="Steven's Blog" title="Steven's Blog"></a><h1><a href="/" alt="Steven's Blog" title="Steven's Blog" itemprop="headline">Steven's Blog</a></h1><p itemprop="description">Note on development</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name"><a href="/" alt="Home" title="Home" itemprop="url">Home</a></li><li itemprop="name"><a href="/projects" alt="Projects" title="Projects" itemprop="url">Projects</a></li><li itemprop="name"><a href="/about" alt="About" title="About" itemprop="url">About</a></li></ul></nav><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><article class="full"><h1 itemprop="headline">How to use JWT to authenticate API end-point request</h1><span class="post-meta">Published on<time itemprop="datePublished" datetime="2017-06-24T04:15:31.000Z"> Saturday, June 24th 2017 at 12:15</time><br>Last updated on<time itemprop="dateModified" datetime="2017-06-24T04:15:31.000Z"> Tuesday, May 21st 2019 at 15:08</time></span><p>JWT means <a href="https://jwt.io/" target="_blank" rel="noopener">JSON Web Token</a>, which is a <strong>compact</strong> and <strong>self-contained</strong> authentication method. The main counterpart of JWT might be traditional session or cookies methods which help user keep state and do security authentication check, as the HTTP is stateless. However, from my point, JWT is much more <strong>scalable</strong>, because once server side authenticates and issues a token, the client side has fully control to decide which request will include this token and which are not.</p>
<p>The following image explains the workflow of JWT authentication process:<br><a id="more"></a><br><img src="/images/jwt_auth_flow.png" alt="JWT Flow" title="JWT Flow"></p>
<blockquote>
<p><i class="fa fa-info-circle"></i> Flow Explain</p>
</blockquote>
<p>Take user login process as an example, the client side sends user name and password to server side, once the server sides verified the user information, it will sign a JWT token, and send it back to client side. Then, when next time client side sends request to server side should contain this token, it could be set in the HTTP header, HTTP body, or even URL query string. After that, server side will check this token, if it is correct, server can handle it to next process. Otherwise, 403 will be issued.</p>
<p>Take a TODO list API protection as a real example, more detail will be explained in this example. This example will only take the related code snippet to explain, the full project code could be found here <a href="https://github.com/StevenZiu/Hi-Today" target="_blank" rel="noopener">HiToday</a>;</p>
<p><i class="fa fa-check-circle"></i> <strong>Step One - Setup Secret in config file</strong></p>
<p>JWT will use a secret to generate a token, as well as verify a token, this secret should be a string. As this string should be constant through the whole App development, we set it in a standalone directory - /config, save as a new file called secret.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//secret.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="string">'secret'</span>: <span class="string">'iamstevenzhao'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><i class="fa fa-check-circle"></i> <strong>Step Two - Setup Router Handler to Sign a Token</strong></p>
<p>First in the app.js root server file import this config module then, store this secret in the app object for global access, and also setup a route to handle authentication request.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="comment">//import needed modules</span></span><br><span class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">'./config/secret'</span>);</span><br><span class="line"><span class="keyword">var</span> authentication = <span class="built_in">require</span>(<span class="string">'./routes/authentication'</span>),</span><br><span class="line"><span class="comment">//make it be global access</span></span><br><span class="line">app.set(<span class="string">'secret'</span>, config.secret);</span><br><span class="line"><span class="comment">//setup authentication api</span></span><br><span class="line">app.use(<span class="string">'/auth'</span>, authentication);</span><br></pre></td></tr></table></figure>
<p>The authentication route handler is the place where client side passes the user authentication data, such as the user name, password or email. So here we need to do two things, compare user input with database data, if it is correct, sign a jwt token and send it back to client side, otherwise, send 403 or 400 to client side. In this example, the user input data is stored in the request body. </p>
<p>The code is here.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//authentication.js</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> authRouter = express.Router();</span><br><span class="line"><span class="keyword">var</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = authRouter;</span><br><span class="line"></span><br><span class="line"><span class="comment">// process token included in the post body</span></span><br><span class="line">authRouter.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.body.key)&#123;</span><br><span class="line">    <span class="comment">// store db instance</span></span><br><span class="line">    <span class="keyword">var</span> keys = req.keys_db;</span><br><span class="line">    <span class="keyword">var</span> inputKey = req.body.key;</span><br><span class="line">    <span class="comment">// verify the key</span></span><br><span class="line">    keys.find(&#123;<span class="attr">key</span>: inputKey&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(data.length)&#123;</span><br><span class="line">      <span class="comment">// Authenticate successfully</span></span><br><span class="line">      jwt.sign(data[<span class="number">0</span>].key, req.app.get(<span class="string">'secret'</span>), <span class="function"><span class="keyword">function</span>(<span class="params">err, token</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(err) res.status(<span class="number">500</span>).send(<span class="string">'Token can not be generated'</span>);</span><br><span class="line">        <span class="keyword">if</span>(token)&#123;</span><br><span class="line">          res.status(<span class="number">200</span>).send(token);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// Authentication fail</span></span><br><span class="line">        res.status(<span class="number">400</span>).send(<span class="string">'Password is incorrect'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      res.status(<span class="number">400</span>).send(<span class="string">'Key can not be empty'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>One thing needs to remind here is that jwt.sign function take the first parameter as the encryption target, and second parameter as secret or key, then a callback function is treated as the third parameter.<br>More detail about jwt.sign please refer to <a href="https://jwt.io/" target="_blank" rel="noopener">here</a>.</p>
<p>In this APP, I use <a href="https://www.mongodb.com/" target="_blank" rel="noopener">mongodb</a> as database, and initializing the database while the app bootstrap, then store the table instance in the req object. As the mongodb is not the main topic of this article, we will talk it in detail in other articles. </p>
<p>At this moment, we have successfully verify the user indentity, and pass the signed token to client side.</p>
<p><i class="fa fa-check-circle"></i> <strong>Step Three - Setup frontend js to store the signed token</strong></p>
<p>How could we store the token in the frontend, there are lots of ways to realize this, it could be stored in the browser, or session, or frontend controller. In this example, frontend logic is controlled by <a href="https://angularjs.org/" target="_blank" rel="noopener">Angularjs</a>, and I user a standalone controller to handler auth related staff.</p>
<p>The auth controller is here:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// authController</span></span><br><span class="line">.controller(<span class="string">'authController'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$rootScope, $scope, $location, hi, httpCaller</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    self.authForm = &#123;</span><br><span class="line">        key: <span class="string">''</span></span><br><span class="line">    &#125;;</span><br><span class="line">    self.submitKey = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      httpCaller</span><br><span class="line">        .auth(self.authForm.key)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span>(<span class="params">token</span>)</span>&#123;</span><br><span class="line">          $rootScope.token = token;</span><br><span class="line">          $rootScope.auth = <span class="literal">true</span>;</span><br><span class="line">          $location.path(<span class="string">'/task'</span>);</span><br><span class="line">          &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(err) hi.callToast(err.data);</span><br><span class="line">          &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>In order to make the app fully modulized, so I also write a standalone service to handle all http request. Once the user click submit button, the submitKey function will be fired, then httpCaller will fire auth function, which will return a promise. If the promise is resolved the token will be sent back, then store it in the $rootScope, which could be accessed through the whole frontend angular logic.</p>
<p>The following is httpCaller service:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">httpCaller</span> (<span class="params">$http</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// post to authentication route</span></span><br><span class="line">  self.auth = <span class="function"><span class="keyword">function</span>(<span class="params">key</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $http(&#123;</span><br><span class="line">      method: <span class="string">'POST'</span>,</span><br><span class="line">      url: <span class="string">'/auth'</span>,</span><br><span class="line">      data: &#123;<span class="attr">key</span>: key&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">//get</span></span><br><span class="line">  self.getAllTasks = <span class="function"><span class="keyword">function</span>(<span class="params">token, status</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(status === <span class="string">'true'</span> || status === <span class="string">'false'</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> $http(&#123;</span><br><span class="line">        method: <span class="string">'GET'</span>,</span><br><span class="line">        url: <span class="string">'/api/task?token='</span>+token+<span class="string">'&amp;status='</span>+status</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $http(&#123;</span><br><span class="line">      method: <span class="string">'GET'</span>,</span><br><span class="line">      url: <span class="string">'/api/task?token='</span>+token</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">//delete</span></span><br><span class="line">  self.deleteTasks = <span class="function"><span class="keyword">function</span>(<span class="params">token, parameters</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> queryString = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span>(parameters.status &amp;&amp; parameters.id)&#123;</span><br><span class="line">      queryString = <span class="string">'/api/task?status='</span>+parameters.status+<span class="string">'&amp;_id='</span>+parameters.id;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(parameters.status)&#123;</span><br><span class="line">      queryString = <span class="string">'/api/task?status='</span>+parameters.status;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(parameters.id)&#123;</span><br><span class="line">      queryString = <span class="string">'/api/task?_id='</span>+parameters.id;</span><br><span class="line">    &#125;</span><br><span class="line">    queryString += <span class="string">'&amp;token='</span> + token;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(queryString)&#123;</span><br><span class="line">      <span class="keyword">return</span> $http(&#123;</span><br><span class="line">        method: <span class="string">'DELETE'</span>,</span><br><span class="line">        url: queryString</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Delete Task Fail'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//create</span></span><br><span class="line">  self.createNewTask = <span class="function"><span class="keyword">function</span>(<span class="params">token, data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(data !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> data == <span class="string">'object'</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> $http.post(<span class="string">'/api/task?token='</span>+token, data);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'empty task content'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//update</span></span><br><span class="line">  self.updateTask = <span class="function"><span class="keyword">function</span>(<span class="params">token, id, data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> queryUrl = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span>(id &amp;&amp; <span class="keyword">typeof</span> data === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> data !== <span class="string">'null'</span>)&#123;</span><br><span class="line">      queryUrl = <span class="string">'/api/task?token='</span>+token+<span class="string">'&amp;id='</span>+id;</span><br><span class="line">      <span class="keyword">return</span> $http.put(queryUrl, data);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Besides the request auth function, there are other CRUD command functions. Need to notice that, all the CRUD task have included the token in their request, the token could be stored in the request body, or url query string.</p>
<p>Up to now, we have successfully handled the token in the frontend js. The last step will go back to backend, after token included request is sent from the frontend.</p>
<p><i class="fa fa-check-circle"></i> <strong>Step Four - Setup API protect middleware to verify token</strong></p>
<p>First we go back to app.js file to setup API route entry point:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="comment">//import api router</span></span><br><span class="line">api = <span class="built_in">require</span>(<span class="string">'./routes/api'</span>);</span><br><span class="line"><span class="comment">//CRUD API for Application</span></span><br><span class="line">app.use(<span class="string">'/api/task'</span>, api.task);</span><br></pre></td></tr></table></figure>
<p>Task router handler will process all the CRUD requests, which is also needed to be protect. That means only the authenticated user can call these API endpoint. So we do it like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api.js</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Serve JSON to our AngularJS client</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * API define here</span></span><br><span class="line"><span class="comment"> * **/</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// varify token</span></span><br><span class="line">router.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.body.token || req.query.token)&#123;</span><br><span class="line">    <span class="keyword">var</span> token = req.body.token || req.query.token;</span><br><span class="line">    jwt.verify(token, req.app.get(<span class="string">'secret'</span>), <span class="function"><span class="keyword">function</span>(<span class="params">err, decoded</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(err)&#123;</span><br><span class="line">        res.status(<span class="number">403</span>).send(<span class="string">'Forbidden! Token is incorrect'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      next();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    res.status(<span class="number">403</span>).send(<span class="string">'Forbidden! Token missing'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.task_db)&#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'No Database Instance'</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Some general functions for query db</span></span><br><span class="line"><span class="comment"> * **/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAll</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  req.task_db.find(&#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) next(<span class="keyword">new</span> <span class="built_in">Error</span>(err));</span><br><span class="line">    data = data.reverse();</span><br><span class="line">    res.json(data);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Preprocess the params from route</span></span><br><span class="line"><span class="comment"> * **/</span></span><br><span class="line"></span><br><span class="line">router.param(<span class="string">'status'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next, status</span>)</span>&#123;</span><br><span class="line">  req.taskStatus = status;</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.param(<span class="string">'id'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next, id</span>)</span>&#123;</span><br><span class="line">  req.taskId = id;</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * url: /api/task</span></span><br><span class="line"><span class="comment"> * method: get</span></span><br><span class="line"><span class="comment"> * behaviour: Display all tasks or filter by status</span></span><br><span class="line"><span class="comment"> * **/</span></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(_.isEmpty(req.query))&#123;</span><br><span class="line">    getAll(req, res);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(req.query.status == <span class="string">'false'</span> || req.query.status == <span class="string">'true'</span> )&#123;</span><br><span class="line">      req.task_db.find(req.query, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(err) next(<span class="keyword">new</span> <span class="built_in">Error</span>(err));</span><br><span class="line">        res.json(data);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      getAll(req, res);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * url: /api/task/create</span></span><br><span class="line"><span class="comment"> * method: create</span></span><br><span class="line"><span class="comment"> * behaviour: create a new task, the name can not be duplicate,</span></span><br><span class="line"><span class="comment"> * then fetch all the tasks</span></span><br><span class="line"><span class="comment"> * **/</span></span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!_.isEmpty(req.body))&#123;</span><br><span class="line">  <span class="comment">//  todo check post data, should have a test function to check req.body data</span></span><br><span class="line">  <span class="comment">//  todo before instance new document</span></span><br><span class="line">    req.task_db.find(&#123;<span class="attr">name</span>: req.body.name&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(!data.length)&#123;</span><br><span class="line">        <span class="keyword">var</span> temp = req.task_db(req.body);</span><br><span class="line">        temp.save(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span>(err) next(<span class="keyword">new</span> <span class="built_in">Error</span>(err));</span><br><span class="line">          getAll(req, res);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Can not create same task again"</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Create Fail, body is empty"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * url: /api/task</span></span><br><span class="line"><span class="comment"> * method: delate</span></span><br><span class="line"><span class="comment"> * behaviour: Delete one task by Id or delete all tasks by status</span></span><br><span class="line"><span class="comment"> * if query object is empty, fetch all tasks;</span></span><br><span class="line"><span class="comment"> * **/</span></span><br><span class="line"></span><br><span class="line">router.delete(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!_.isEmpty(req.query))&#123;</span><br><span class="line">    <span class="comment">// delete token before pass it to db query</span></span><br><span class="line">    <span class="keyword">delete</span> req.query.token;</span><br><span class="line">    req.task_db.find(req.query, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(err) next(<span class="keyword">new</span> <span class="built_in">Error</span>(err));</span><br><span class="line">      <span class="keyword">if</span>(data.length)&#123;</span><br><span class="line">        req.task_db.deleteMany(req.query).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          getAll(req, res);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Can not find match task to delete'</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    getAll(req, res);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * url: /api/task</span></span><br><span class="line"><span class="comment"> * method: update</span></span><br><span class="line"><span class="comment"> * behaviour: update one task</span></span><br><span class="line"><span class="comment"> * if query object is empty, fetch all tasks;</span></span><br><span class="line"><span class="comment"> * **/</span></span><br><span class="line"></span><br><span class="line">router.put(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!_.isEmpty(req.body) &amp;&amp; !_.isEmpty(req.query.id))&#123;</span><br><span class="line">    req.task_db.findByIdAndUpdate(req.query.id, req.body, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(err) next(<span class="keyword">new</span> <span class="built_in">Error</span>(err));</span><br><span class="line">      getAll(req, res);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Can not find target to update'</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">exports.task = router;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Very important!!!!</strong><br>To make sure all the request should be checked, we should put the token verify middleware at the very top of this router process. Only the token is verified, we call next() to process it to next router handler or middleware function. Otherwise, should redirect to forbidden.</p>
</blockquote>
<p>As the jwt.verify function, it takes the token as the first parameter, and secret as the second one, if the token is verified successfully, the err will be empty.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api.js</span></span><br><span class="line"><span class="comment">// token verify</span></span><br><span class="line">router.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.body.token || req.query.token)&#123;</span><br><span class="line">    <span class="keyword">var</span> token = req.body.token || req.query.token;</span><br><span class="line">    jwt.verify(token, req.app.get(<span class="string">'secret'</span>), <span class="function"><span class="keyword">function</span>(<span class="params">err, decoded</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(err)&#123;</span><br><span class="line">        res.status(<span class="number">403</span>).send(<span class="string">'Forbidden! Token is incorrect'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      next();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    res.status(<span class="number">403</span>).send(<span class="string">'Forbidden! Token missing'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><i class="fa fa-check-circle"></i> <strong>Conclusion</strong></p>
<p>This article explains how to implement JSON Web Token to protect API endpoint, as you can see, it’s not complicated as we think before. Actually, there are more complicated ways to launch the JWT in the application, for example, you could use some other methods to encrypt token, which will generate a second security layer. Or use more security places to store token. </p>
<p>Hope this article helps you. Happy Coding.</p>
</article></main><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-106933947-1');ga('send','pageview');</script></body></html>